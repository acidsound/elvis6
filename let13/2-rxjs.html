<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title> free will </title>
    <script src="../libs/async.js"></script>
    <script src="../libs/Tween.js"></script>
    <script src="../libs/utils.js"></script>
    <script src="../libs/three.min.js"></script>
    <script src="../libs/Rx.min.js"></script>
</head>
<body>

<div>
    <canvas id="myCanvas" width="320" height="240" style="border: solid 1px black" ></canvas>
</div>

<script>
    var canvas = document.querySelector('#myCanvas');
    var context = canvas.getContext('2d');

    function beginNewFramw() {
        //중점이동 초기화
        context.setTransform(1,0,0,1,canvas.width/2, canvas.height/2); //변환행렬 초기화
        //회면지우기
        context.clearRect(-canvas.width/2,-canvas.height/2,canvas.width,canvas.height);
        //십자선그리기
        context.beginPath();
        context.strokeStyle = "#000000";
        context.moveTo(-canvas.width/2,0);
        context.lineTo(canvas.width/2,0);
        context.stroke()
        context.beginPath();
        context.moveTo(0,-canvas.height/2);
        context.lineTo(0,canvas.height/2);
        context.stroke();
        context.closePath();
    }

    var tds_human_path = "../res/2d/tds_human/";
    var tds_human_files = {
        idle_0 : tds_human_path + 'handgun/idle/survivor-idle_handgun_0.png',
        idle_1 : tds_human_path + 'handgun/idle/survivor-idle_handgun_1.png',
        idle_2 : tds_human_path + 'handgun/idle/survivor-idle_handgun_2.png',
        idle_3 : tds_human_path + 'handgun/idle/survivor-idle_handgun_3.png',
        idle_4 : tds_human_path + 'handgun/idle/survivor-idle_handgun_4.png',
        idle_5 : tds_human_path + 'handgun/idle/survivor-idle_handgun_5.png',
        idle_6 : tds_human_path + 'handgun/idle/survivor-idle_handgun_6.png',
        idle_7 : tds_human_path + 'handgun/idle/survivor-idle_handgun_7.png',
        idle_8 : tds_human_path + 'handgun/idle/survivor-idle_handgun_8.png',
        idle_9 : tds_human_path + 'handgun/idle/survivor-idle_handgun_9.png',
        idle_10 : tds_human_path + 'handgun/idle/survivor-idle_handgun_10.png',
        idle_11 : tds_human_path + 'handgun/idle/survivor-idle_handgun_11.png',
        idle_12 : tds_human_path + 'handgun/idle/survivor-idle_handgun_12.png',
        idle_13 : tds_human_path + 'handgun/idle/survivor-idle_handgun_13.png',
        idle_14 : tds_human_path + 'handgun/idle/survivor-idle_handgun_14.png',
        idle_15 : tds_human_path + 'handgun/idle/survivor-idle_handgun_15.png',
        idle_16 : tds_human_path + 'handgun/idle/survivor-idle_handgun_16.png',
        idle_17 : tds_human_path + 'handgun/idle/survivor-idle_handgun_17.png',
        idle_18 : tds_human_path + 'handgun/idle/survivor-idle_handgun_18.png',
        idle_19 : tds_human_path + 'handgun/idle/survivor-idle_handgun_19.png',
        shoot_0 : tds_human_path + 'handgun/shoot/survivor-shoot_handgun_0.png',
        shoot_1 : tds_human_path + 'handgun/shoot/survivor-shoot_handgun_1.png',
        shoot_2 : tds_human_path + 'handgun/shoot/survivor-shoot_handgun_2.png',
        move_0 : tds_human_path + 'handgun/move/survivor-move_handgun_0.png',
        move_1 : tds_human_path + 'handgun/move/survivor-move_handgun_1.png',
        move_2 : tds_human_path + 'handgun/move/survivor-move_handgun_2.png',
        move_3 : tds_human_path + 'handgun/move/survivor-move_handgun_3.png',
        move_4 : tds_human_path + 'handgun/move/survivor-move_handgun_4.png',
        move_5 : tds_human_path + 'handgun/move/survivor-move_handgun_5.png',
        move_6 : tds_human_path + 'handgun/move/survivor-move_handgun_6.png',
        move_7 : tds_human_path + 'handgun/move/survivor-move_handgun_7.png',
        move_8 : tds_human_path + 'handgun/move/survivor-move_handgun_8.png',
        move_9 : tds_human_path + 'handgun/move/survivor-move_handgun_9.png',
        move_10 : tds_human_path + 'handgun/move/survivor-move_handgun_10.png',
        move_11 : tds_human_path + 'handgun/move/survivor-move_handgun_11.png',
        move_12 : tds_human_path + 'handgun/move/survivor-move_handgun_12.png',
        move_13 : tds_human_path + 'handgun/move/survivor-move_handgun_13.png',
        move_14 : tds_human_path + 'handgun/move/survivor-move_handgun_14.png',
        move_15 : tds_human_path + 'handgun/move/survivor-move_handgun_15.png',
        move_16 : tds_human_path + 'handgun/move/survivor-move_handgun_16.png',
        move_17 : tds_human_path + 'handgun/move/survivor-move_handgun_17.png',
        move_18 : tds_human_path + 'handgun/move/survivor-move_handgun_18.png',
        move_19 : tds_human_path + 'handgun/move/survivor-move_handgun_19.png'

    }

    var tds_zombie = "../res/2d/tds_zombie/";
    var tds_zombie_files = {
        idle_0 : tds_zombie + 'skeleton-idle_0.png',
        idle_1 : tds_zombie + 'skeleton-idle_1.png',
        idle_2 : tds_zombie + 'skeleton-idle_2.png',
        idle_3 : tds_zombie + 'skeleton-idle_3.png',
        idle_4 : tds_zombie + 'skeleton-idle_4.png',
        idle_5 : tds_zombie + 'skeleton-idle_5.png',
        idle_6 : tds_zombie + 'skeleton-idle_6.png',
        idle_7 : tds_zombie + 'skeleton-idle_7.png',
        idle_8 : tds_zombie + 'skeleton-idle_8.png',
        idle_9 : tds_zombie + 'skeleton-idle_9.png',
        idle_10 : tds_zombie + 'skeleton-idle_10.png',
        idle_11 : tds_zombie + 'skeleton-idle_11.png',
        idle_12 : tds_zombie + 'skeleton-idle_12.png',
        idle_13 : tds_zombie + 'skeleton-idle_13.png',
        idle_14 : tds_zombie + 'skeleton-idle_14.png',
        idle_15 : tds_zombie + 'skeleton-idle_15.png',
        idle_16 : tds_zombie + 'skeleton-idle_16.png',
        move_0 : tds_zombie + 'skeleton-move_0.png',
        move_1 : tds_zombie + 'skeleton-move_1.png',
        move_2 : tds_zombie + 'skeleton-move_2.png',
        move_3 : tds_zombie + 'skeleton-move_3.png',
        move_4 : tds_zombie + 'skeleton-move_4.png',
        move_5 : tds_zombie + 'skeleton-move_5.png',
        move_6 : tds_zombie + 'skeleton-move_6.png',
        move_7 : tds_zombie + 'skeleton-move_7.png',
        move_8 : tds_zombie + 'skeleton-move_8.png',
        move_9 : tds_zombie + 'skeleton-move_9.png',
        move_10 : tds_zombie + 'skeleton-move_10.png',
        move_11 : tds_zombie + 'skeleton-move_11.png',
        move_12 : tds_zombie + 'skeleton-move_12.png',
        move_13 : tds_zombie + 'skeleton-move_13.png',
        move_14 : tds_zombie + 'skeleton-move_14.png',
        move_15 : tds_zombie + 'skeleton-move_15.png',
        move_16 : tds_zombie + 'skeleton-move_16.png',
        attack_0 : tds_zombie + 'skeleton-attack_0.png',
        attack_1 : tds_zombie + 'skeleton-attack_1.png',
        attack_2 : tds_zombie + 'skeleton-attack_2.png',
        attack_3 : tds_zombie + 'skeleton-attack_3.png',
        attack_4 : tds_zombie + 'skeleton-attack_4.png',
        attack_5 : tds_zombie + 'skeleton-attack_5.png',
        attack_6 : tds_zombie + 'skeleton-attack_6.png',
        attack_7 : tds_zombie + 'skeleton-attack_7.png',
        attack_8 : tds_zombie + 'skeleton-attack_8.png'
    }

    var charAnimObj = {
        FrameIndex : 0,
        status : 'idle',
        position : new THREE.Vector3(100,100,0),
        rotation : 0,
        images: {},
        putSprite : function () {

            context.setTransform(1,0,0,1,canvas.width/2, canvas.height/2); //변환행렬 초기화
            context.translate(this.position.x,this.position.y);
            context.scale(0.3,0.3);
            context.rotate( (this.rotation -90) * Math.PI/180);

            if(this.status == "die") {


                context.beginPath()
                context.arc(0,0,25, 0, 2 * Math.PI, false);
                context.fillStyle = "#880000";
                context.fill();

                context.arc(10,15,20, 0, 2 * Math.PI, false);
                context.fillStyle = "#ee0000";
                context.fill();
            }
            else {
                var imageObj = this.images[ this.status + "_"+  Math.round(this.FrameIndex) ];
                context.drawImage(imageObj, 0-imageObj.width/2, 0-imageObj.height/2);
            }




        },
        changeIdleAnim : function () {
            this.FrameIndex = 0;
            this.status = 'idle';
            this.tw_idle = new TWEEN.Tween( this )
                    .to( {
                        FrameIndex : 19
                    }, 1000)
                    .easing( TWEEN.Easing.Linear.None )
                    .repeat(Infinity);
            this.tw_idle.start();
        },
        changeShootAnim :function () {
            this.FrameIndex = 0;
            this.status = 'shoot';
            this.tw_shoot = new TWEEN.Tween( this )
                    .to( {
                        FrameIndex : 2
                    }, 1000)
                    .easing( TWEEN.Easing.Linear.None );
            charAnimObj.tw_shoot.start();

        },
        changeMoveAnim : function () {
            this.FrameIndex = 0;
            this.status = 'move';
            this.tw_shoot = new TWEEN.Tween( this )
                    .to( {
                        FrameIndex : 19
                    }, 1000)
                    .easing( TWEEN.Easing.Linear.None );
            this.tw_shoot.start();
        }
    };


    var zombieAniObj = {
        FrameIndex : 0,
        status : 'idle',
        position : new THREE.Vector3(0,0,0),
        collusion_radius : 25,
        rotation : 0,
        images : {},
        Fsm : 'idle',
        putSprite : function () {

            context.setTransform(1,0,0,1,canvas.width/2, canvas.height/2); //변환행렬 초기화
            context.translate(this.position.x,this.position.y);
            context.scale(0.3,0.3);
            context.rotate( (this.rotation -90) * Math.PI/180);

            if(this.status == "die") {

                context.beginPath()
                context.arc(0,0,25, 0, 2 * Math.PI, false);
                context.fillStyle = "#880000";
                context.fill();

                context.arc(10,15,20, 0, 2 * Math.PI, false);
                context.fillStyle = "#ee0000";
                context.fill();
            }
            else {
                var imageObj = this.images[ this.status + "_"+  Math.round(this.FrameIndex) ];
                context.drawImage(imageObj, 0-imageObj.width/2, 0-imageObj.height/2);
            }

        },
        changeIdleAnim : function () {
            this.FrameIndex = 0;
            this.status = 'idle';
            this.tw_idle = new TWEEN.Tween( this )
                    .to( {
                        FrameIndex : 16
                    }, 1000)
                    .easing( TWEEN.Easing.Linear.None )
                    .repeat(Infinity);
            this.tw_idle.start();
        },
        changeAttackAnim : function () {
            this.FrameIndex = 0;
            this.status = 'attack';
            this.tw_idle = new TWEEN.Tween( this )
                    .to( {
                        FrameIndex : 8
                    }, 1000)
                    .easing( TWEEN.Easing.Linear.None )
                    .repeat(Infinity);
            this.tw_idle.start();
        },
        changeMoveAnim : function () {
            this.FrameIndex = 0;
            this.status = 'move';
            this.tw_idle = new TWEEN.Tween( this )
                    .to( {
                        FrameIndex : 16
                    }, 1000)
                    .easing( TWEEN.Easing.Linear.None )
                    .repeat(Infinity);
            this.tw_idle.start();
        }
    }

    var keyInputTrigger = {
        statusTable : {
            "KeyW" : false,
            "KeyS" : false,
            "KeyA" : false,
            "KeyD" : false
        },
        triggerTable : {

        },
        callback : function (delta) {},
        setCallback : function (cb) {
            this.callback = cb.bind(this)
        }

    }

    var AiTrigger = {
        callback : function (delta) {},
        setCallback : function (cb) {
            this.callback = cb.bind(this)
        }
    }



    function startApp_old() {

        keyInputTrigger.setCallback(function (delta) {

            var front_vect = new THREE.Vector3(0,1,0);
            var side_vect = new THREE.Vector3(1,0,0);

            //회전적용
            var quaternion = new THREE.Quaternion();
            quaternion.setFromAxisAngle( new THREE.Vector3( 0, 0, 1 ), charAnimObj.rotation * Math.PI / 180 );
            front_vect.applyQuaternion(quaternion);
            side_vect.applyQuaternion(quaternion);

            switch (charAnimObj.Fsm) {
                case "idle":
                    if(this.statusTable["KeyW"] == true
                            || this.statusTable["KeyS"] == true
                            || this.statusTable["KeyA"] == true
                            || this.statusTable["KeyD"] == true
                    ) {
                        charAnimObj.Fsm = "move";
                        charAnimObj.changeMoveAnim();
                    }
                    else if(this.triggerTable["Space"] == true) {

                        /*-----------실습 코드 시작--------------------------*/

                        this.triggerTable["Space"] = false;
                        charAnimObj.Fsm = "shoot";
                        charAnimObj.changeShootAnim();

                        let ray_1 = new THREE.Ray(
                                new THREE.Vector3(charAnimObj.position.x,charAnimObj.position.y,0),
                                front_vect.negate());
                        let sphere_1 = new THREE.Sphere(zombieAniObj.position,zombieAniObj.collusion_radius);
                        let coll = ray_1.intersectSphere(sphere_1);

                        if(coll != null ) {
                            zombieAniObj.Fsm =  zombieAniObj.status = "die";
                        }

                        /*-----------실습 코드 끝--------------------------*/

                    }
                    break;
                case "move":
                    if(this.statusTable["KeyW"] == false && this.statusTable["KeyS"] == false
                            && this.statusTable["KeyA"] == false
                            && this.statusTable["KeyD"] == false

                    ) {
                        charAnimObj.Fsm = "idle";
                        charAnimObj.changeIdleAnim();
                    }

                    if(this.statusTable["KeyW"] == true) {

                        charAnimObj.position.addScaledVector(front_vect,-delta * 20)
                    }
                    else if(this.statusTable["KeyS"] == true) {
                        //charAnimObj.position.y -= delta * 10;
                        charAnimObj.position.addScaledVector(front_vect,delta * 10 )
                    }

                    if(this.statusTable["KeyA"] == true) {
                        charAnimObj.rotation -= delta*90;


                    }
                    else if(this.statusTable["KeyD"] == true) {
                        charAnimObj.rotation += delta*90;
                    }
                    break;
                case "shoot":

                    if(charAnimObj.FrameIndex == 2) {
                        charAnimObj.Fsm = "idle";
                        charAnimObj.changeIdleAnim();
                    }
                    break;
            }
        });

        AiTrigger.setCallback(function (delta) {

            var thisObj = zombieAniObj;

            var front_vect = new THREE.Vector3(0,1,0);
            var side_vect = new THREE.Vector3(1,0,0);
            //회전적용
            var quaternion = new THREE.Quaternion();
            quaternion.setFromAxisAngle( new THREE.Vector3( 0, 0, 1 ), thisObj.rotation * Math.PI / 180 );
            front_vect.applyQuaternion(quaternion);
            side_vect.applyQuaternion(quaternion);

            /*---------------------- 실습코드 시작 ------------------------------*/
            switch (thisObj.Fsm) {
                case "idle":
                    break;
                case "move":
                    setTimeout(function () {
                        if(thisObj.Fsm != "die") {
                            thisObj.Fsm="think";
                            thisObj.status="idle"
                        }

                    },5000)
                    thisObj.Fsm = "move_2";
                    break;
                case "move_2":
                    if(thisObj.dest_rotation > thisObj.rotation) {
                        thisObj.rotation += delta*45;
                    }
                    else if(thisObj.dest_rotation < thisObj.rotation) {
                        thisObj.rotation -= delta*45;
                    }

                    thisObj.position.addScaledVector(front_vect,-delta * 10);
                    break;
                case "trace_move":

                {
                    let forword_vect = new THREE.Vector3(0,1,0);
                    let dir_char = new THREE.Vector3();
                    dir_char.subVectors(charAnimObj.position,thisObj.position);
                    dir_char.normalize();

                    let target_angle;

                    if(thisObj.position.x > charAnimObj.position.x) {
                        target_angle = THREE.Math.radToDeg( forword_vect.angleTo(dir_char) );

                    }
                    else {
                        target_angle = 360 - THREE.Math.radToDeg( forword_vect.angleTo(dir_char) );

                    }
                    //console.log(THREE.Math.radToDeg(target_angle));
                    thisObj.dest_rotation = target_angle - 180;

                    if(thisObj.dest_rotation > thisObj.rotation) {
                        thisObj.rotation += delta*45;
                    }
                    else if(thisObj.dest_rotation < thisObj.rotation) {
                        thisObj.rotation -= delta*45;
                    }

                    thisObj.position.addScaledVector(front_vect,-delta * 10);

                    let dist = thisObj.position.distanceTo( charAnimObj.position );
                    if(dist < 25) {
                        thisObj.Fsm="attack";
                        thisObj.changeAttackAnim();
                    }
                }

                    break;
                case "attack":
                    if(thisObj.FrameIndex == 8) {
                        thisObj.changeIdleAnim();
                        thisObj.Fsm = "think";

                        charAnimObj.status = charAnimObj.Fsm = "die";
                    }
                    break;

                case "think":
                    let dist = thisObj.position.distanceTo( charAnimObj.position );

                    if(dist < 100 &&
                            charAnimObj.status != "die" //먹이감이 살아 있다.
                    ) {
                        thisObj.Fsm = "trace_move";
                        thisObj.status="move"
                    }
                    else {
                        thisObj.dest_rotation = Math.random() * 360;
                        thisObj.Fsm = "idle";
                        setTimeout(function () {
                            if(thisObj.Fsm != "die") {
                                thisObj.Fsm="move";
                                thisObj.changeMoveAnim()
                            }
                        },1000)
                    }
                    break;
                case "die":

                    break;
            }

            /*---------------------- 실습코드 끝 ------------------------------*/

        });

        console.log('start app')

    }

/** ticker */
const frame = 1000/60; /* 60frame */
const ticker$ = Rx.Observable.interval(frame)
  .scan((prev,now)=>({
    tick: Date.now(), delta: (Date.now()-prev.tick)/1000, frame: now}), {
    tick: Date.now(), delta: 0, frame: 0
  });

/** Key Stroke */
const keyUp$ = Rx.Observable.fromEvent(document, 'keyup').map(evt=>evt.code);
const keyDown$ = Rx.Observable.fromEvent(document, 'keydown').map(evt=>evt.code);

const charFrontBack$ = keyDown$
  .filter(o=>o === 'KeyW' || o === 'KeyS')
  .map(o=>~['KeyW','KeyS'].indexOf(o))
  .map(o=>o < 0 ? ~o*2-1 : 0)
  .merge(keyUp$.filter(o=>o === 'KeyW' || o === 'KeyS').map(o=>0))
  .startWith(0);
const charLeftRight$ = keyDown$
  .filter(o=>o === 'KeyA' || o === 'KeyD')
  .map(o=>~['KeyA','KeyD'].indexOf(o))
  .map(o=>o < 0 ? ~o*2-1 : 0)
  .merge(keyUp$.filter(o=>o === 'KeyA' || o === 'KeyD').map(o=>0))
  .startWith(0);
const charFire$ = keyDown$
  .filter(o=>o === 'Space')
  .map(o=>1)
  .merge(keyUp$.filter(o=>o === 'Space').map(o=>0))
  .distinctUntilChanged()
  .startWith(0);

const reduceCharAnimObj = (status, [tick, frontBack, leftRight, fire])=> {
  var front_vect = new THREE.Vector3(0,1,0);
  var side_vect = new THREE.Vector3(1,0,0);
  //회전적용
  var quaternion = new THREE.Quaternion();
  quaternion.setFromAxisAngle(
    new THREE.Vector3( 0, 0, 1 ),
    status.rotation * Math.PI / 180
  );
  front_vect.applyQuaternion(quaternion);
  side_vect.applyQuaternion(quaternion);
  status.Fsm = frontBack && "move" || "idle";
  status.Fsm = fire && "shoot" || status.Fsm;
  status.status = status.Fsm;
  status.frame = status.status === "shoot" ? 3 : 20;
  Object.assign(
    status, {
      position: status.position.addScaledVector(front_vect, frontBack* tick.delta * 30),
      rotation: status.rotation + (leftRight * tick.delta*90)
    }
  );

  status.FrameIndex = ~~((tick.frame / 3) % status.frame);
  return status;
};

const charObject$ = ticker$.withLatestFrom(charFrontBack$,charLeftRight$,charFire$)
  .scan(reduceCharAnimObj, charAnimObj);

const startApp = ()=>
  ticker$.withLatestFrom(charObject$)
  .subscribe(([tick,char])=>{
    beginNewFramw();
    char.putSprite();
/*
    zombie.putSprite();
*/
  });

const loadImagesStream = (source)=>
  new Rx.Observable.create(observe=> {
    let sources = tds_human_files;
    let i=0;
    let t=Object.keys(sources).length; 
    for (let src in sources) {
      let img = new Image();
      img.onload = ()=> {
        i++;
        observe.next({ idx: i, total: t, key: src, image: img });
        if (i===t) observe.complete();
      }
      img.src = sources[src];
    }
  });

const humanImage$ = loadImagesStream(tds_human_files);
const zombieImage$ = loadImagesStream(tds_zombie_files);

/** images loading */
humanImage$.combineLatest(zombieImage$)
.subscribe({
  next: ([human,zombie])=> {
    charAnimObj.images[human.key]=human.image;
    zombieAniObj.images[zombie.key]=zombie.image; 
    let currentIdx = human.idx + zombie.idx;
    let total = human.total+zombie.total;
    context.strokeRect( 20, canvas.height /2 - 10, canvas.width - 40, 20 );
    context.fillRect( 20, canvas.height /2 - 10, (canvas.width - 40)*(currentIdx/total), 20 );
  },
  complete: startApp
});

zombieImage$.subscribe({complete: ()=> {
  zombieAniObj.changeIdleAnim();
  zombieAniObj.Fsm = "think";
}});
humanImage$.subscribe({complete: ()=> {
  charAnimObj.changeIdleAnim();
  charAnimObj.Fsm = "idle";
}});
</script>



</body>
</html>
